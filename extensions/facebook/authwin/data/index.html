<?xml version="1.0" encoding="utf-8"?>
<!-- CopyLeft (c) PlexyPlanet.org -->

<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link href="style.css" rel="stylesheet" type="text/css" />

    <title>Facebook Feed Wall</title>
    <script>
     function onDataReady(data)
     {
        if (data["command"] == "userfeed") {
            //document.write(data["rawdata"] + " <br>");
            var object = JSON.parse(data["rawdata"]);
            var length = object.feed.data.length;
            
            for (var i = 0; i < object.feed.data.length ; i++) {

              var message = object.feed.data[i].message;
              var picture = object.feed.data[i].picture;
              //var commentCount = object.feed.data[i].comments.count;
              //var commentMessage = object.feed.data[i].comments.data.message;
              
              //document.write ("Comment :" + commentMessage);
              //document.write ("Comment Count:" + commentCount);
              //document.write ("Message : " + message);
              addFeedItem (i, message, picture);
              
            }
        }
     }
     
     function checkUpdate()
     {
       if (FacebookEngine) {
         console.log ("update");
         
         var parent = document.getElementById ("feed_parent");
         
         if (parent) {
             while (parent.firstChild) {
               parent.removeChild(parent.firstChild);
             }
         }

         var args = {};
             args["command"] = "wallpost";
             args["token"] = ContactCard.token();
             args["id"] = ContactCard.facebookId();
             var userImage = ContactCard.userImage();
             
             FacebookEngine.requestData(args);
       }
     }
     
     function start()
     {
         window.onresize = bubbleResized;
         
         if (FacebookEngine)
           FacebookEngine.sourceUpdated.connect(onDataReady);
                      
         checkUpdate();
         setInterval('checkUpdate()', 10000)  
     }

    function bubbleResized ()
    {
       var items = document.getElementsByClassName ("bubble");

       for (i = 0 ; i < items.length ; i++) {
           var textNode = document.getElementById ("content_" + i);
           var imgNode = document.getElementById("img_" + i);
           
           if (textNode) {
               var height = 100;
               height += textNode.clientHeight;
                    
               if (imgNode) {
                   height += imgNode.clientHeight;
               }
            
                console.log ("Image Resized:" + height);
               items[i].style.height =  height + "px";
            }
       }
    }

    function onImageLoadResize()
    {
       console.log("Image loaded");
       bubbleResized();
    }
    function addFeedItem (id, text, img)
    {
       var content = "<div class=\"bubble\" onresize=\"bubbleResized()\" >" +
                     "<img class=\"circle\" id=\"userPicture0\" src=\"http://www.theipadguide.com/images/facebook50x50.jpg\"></img>"  +
                     "<p class=\"bubbletext\"  id=\"content_" + id + "\">" +
                     text;
                     
       if (img) {
         content += "<div style=\"margin-top:10px;\"> <img id=\"img_"+ id +"\" onload=\"onImageLoadResize();\" class=\"imagedropshadow\" src=\""+ img +"\"></img></div>";
       }
       
       content += "</p></div>";

       var parent = document.getElementById ("feed_parent");

       if (parent) {
           parent.innerHTML += content;

           var items = document.getElementsByClassName ("bubble");
           

           for (i = 0 ; i < items.length ; i++) {
                var textNode = document.getElementById ("content_" + i);
                console.log (textNode);
                var imgNode = document.getElementById("img_" + i);
                items[i].style.opacity = "1.0";
           
                if (textNode) {
                    console.log (textNode.clientHeight);
                    var height = 100;
                    height += textNode.clientHeight;
                    
                    if (imgNode) {
                        height += imgNode.clientHeight;
                    }
                    items[i].style.height =  height + "px";
                }
           }
       }
    }
    
    </script>
</head>

<body onload="start();">
    <section id="feed_parent">
      <script>
      </script>
    </section>
</body>
</html>
